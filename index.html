<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DeepYouMap</title>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    
    /* Белая полоса внизу */
    #bottom-panel {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 8px 16px;
      border-radius: 15px;
      z-index: 10;
      font-family: Arial;
      width: 90%;
      max-width: 400px;
      box-sizing: border-box;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    /* Панель даты */
    #date-panel {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .date-button {
      font-size: 20px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0 5px;
    }
    
    #current-date {
      font-size: 16px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    
    /* Кнопка "i" */
    #info-button {
      position: absolute;
      right: 10px;
      top: 10px;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: default;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    /* Белая полоса сверху (рамка) */
    #top-frame {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(255,255,255,0.9);
      z-index: 5;
      display: none; /* Пока скрыта */
    }
    
    /* Адаптация для мобильных */
    @media (max-width: 768px) {
      #bottom-panel {
        bottom: 20px;
        padding: 10px 15px;
      }
      
      #info-button {
        right: 15px;
        top: 15px;
        width: 40px;
        height: 40px;
        border-radius: 12px;
      }
      
      .date-button {
        font-size: 22px;
      }
      
      #current-date {
        font-size: 18px;
        max-width: 180px;
      }
    }
    
    @media (max-width: 480px) {
      #bottom-panel {
        width: 95%;
        padding: 8px 12px;
      }
      
      #date-panel {
        gap: 10px;
      }
      
      .date-button {
        font-size: 18px;
      }
      
      #current-date {
        font-size: 14px;
        max-width: 120px;
      }
    }
  </style>
</head>
<body>

<!-- Белая полоса сверху (рамка) -->
<div id="top-frame"></div>

<!-- Панель управления внизу -->
<div id="bottom-panel">
  <div id="date-panel">
    <button class="date-button" id="prev">&lt;</button>
    <span id="current-date"></span>
    <button class="date-button" id="next">&gt;</button>
  </div>
  <button class="date-button" id="compare">&gt;&lt;</button>
</div>

<!-- Кнопка "i" в правом верхнем углу -->
<button id="info-button" title="Информация">i</button>

<div id="map"></div>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://api.maptiler.com/maps/01966ded-9a2b-7a36-bad5-71bc7e8b2bf7/style.json?key=A7YSMrQ3OZ0oStEWILkD',
  center: [31.1656, 48.3794],
  zoom: 5.5,
  touchZoomRotate: true,
  interactive: true
});

// Упрощенные данные
const idToName = {
  "80c27733-0eea-4845-93f5-e8938d4a79b3": "Крым",
  "5cdb851b-4447-41b6-ae6f-a134e8b00236": "ЛДНР"
};

const occupiedIds = ["22b8b8e8-394b-4625-b388-19cbdd597de5", "e7756804-6807-44a9-8110-c6ab01dda52a"];
const liberatedIds = ["e1682ab0-a5db-47fd-98b1-9be95133d6e6"];
const newLiberatedIds = ["418a53e5-49e1-4ba5-b451-c0e4f733d734", "17e912ab-8e25-4bc9-b8f3-762bbd51e091"];

const availableDates = ["2025-05-20_23-10"];
let currentIndex = availableDates.length - 1;
let currentGeojson = null;
let previousGeojson = null;
let compareActive = false;

function formatArea(area) {
  return (area / 1e6).toFixed(2) + ' км²';
}

async function loadMap(dateStr) {
  try {
    const response = await fetch(`https://vleddd.github.io/DeepMap/maps/map_${dateStr}.geojson`);
    if (!response.ok) throw new Error();
    const geojson = await response.json();
    processGeoJSON(geojson);
  } catch {
    useTestData();
  }
}

function useTestData() {
  const testGeojson = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "id": "test-liberated",
        "properties": {},
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[30.5, 50.5], [31.5, 50.5], [31.5, 49.5], [30.5, 49.5], [30.5, 50.5]]]
        }
      },
      {
        "type": "Feature",
        "id": "test-occupied",
        "properties": {},
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[32.5, 49.5], [33.5, 49.5], [33.5, 48.5], [32.5, 48.5], [32.5, 49.5]]]
        }
      }
    ]
  };
  processGeoJSON(testGeojson);
}

function processGeoJSON(geojson) {
  previousGeojson = currentGeojson;
  currentGeojson = geojson;

  geojson.features.forEach(f => {
    const id = f.id || f.properties.id;
    if (idToName[id]) {
      f.properties.customName = idToName[id];
      f.properties.fillColor = "#b57edc";
    } else if (occupiedIds.includes(id)) {
      f.properties.customName = "Оккупировано";
      f.properties.fillColor = "#d22b2b";
    } else if (newLiberatedIds.includes(id)) {
      f.properties.customName = "Освобождено";
      f.properties.fillColor = "#5BC779";
    } else if (liberatedIds.includes(id)) {
      f.properties.customName = "Освобождено";
      f.properties.fillColor = "#3498db";
    } else {
      f.properties.customName = "Под Вопросом";
      f.properties.fillColor = "#777";
    }
    f.properties.areaFormatted = formatArea(turf.area(f));
  });

  updateMapSource(geojson);
}

function updateMapSource(geojson) {
  if (map.getSource('war-zones')) {
    map.getSource('war-zones').setData(geojson);
  } else {
    map.addSource('war-zones', { type: 'geojson', data: geojson });
    map.addLayer({
      id: 'war-polygons',
      type: 'fill',
      source: 'war-zones',
      paint: {
        'fill-color': ['get', 'fillColor'],
        'fill-opacity': 0.5
      }
    });

    map.addLayer({
      id: 'war-outlines',
      type: 'line',
      source: 'war-zones',
      paint: {
        'line-color': ['get', 'fillColor'],
        'line-width': 1
      }
    });

    map.on('click', 'war-polygons', (e) => {
      new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`<h3>${e.features[0].properties.customName}</h3><p>Площадь: ${e.features[0].properties.areaFormatted}</p>`)
        .addTo(map);
    });
  }
}

function updateDatePanel() {
  if (!map.isStyleLoaded()) {
    setTimeout(updateDatePanel, 100);
    return;
  }

  const [date, time] = availableDates[currentIndex].split('_');
  document.getElementById('current-date').textContent = `${date} ${time.replace('-', ':')}`;
  loadMap(availableDates[currentIndex]);
}

document.getElementById('prev').addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    updateDatePanel();
  }
});

document.getElementById('next').addEventListener('click', () => {
  if (currentIndex < availableDates.length - 1) {
    currentIndex++;
    updateDatePanel();
  }
});

document.getElementById('compare').addEventListener('click', toggleCompare);

function toggleCompare() {
  if (!previousGeojson || !currentGeojson) {
    alert("Нет данных для сравнения");
    return;
  }

  if (compareActive) {
    removeComparisonLayers();
    compareActive = false;
    return;
  }

  showComparison();
  compareActive = true;
}

function removeComparisonLayers() {
  ['change-fill', 'change-outline'].forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
  });
  if (map.getSource('changes')) map.removeSource('changes');
}

function showComparison() {
  const changes = calculateChanges();
  
  if (changes.length === 0) {
    alert("Нет изменений для отображения");
    return;
  }

  map.addSource('changes', {
    type: 'geojson',
    data: { type: 'FeatureCollection', features: changes }
  });

  map.addLayer({
    id: 'change-fill',
    type: 'fill',
    source: 'changes',
    paint: {
      'fill-color': ['get', 'fillColor'],
      'fill-opacity': 0.7
    }
  });

  map.addLayer({
    id: 'change-outline',
    type: 'line',
    source: 'changes',
    paint: {
      'line-color': ['get', 'fillColor'],
      'line-width': 2,
      'line-dasharray': [2, 2]
    }
  });
}

function calculateChanges() {
  const prevFeaturesMap = Object.fromEntries(
    (previousGeojson.features || []).map(f => [f.id || f.properties.id, turf.cleanCoords(f)])
  );
  
  const currFeaturesMap = Object.fromEntries(
    (currentGeojson.features || []).map(f => [f.id || f.properties.id, turf.cleanCoords(f)])
  );

  const changes = [];

  for (const id in currFeaturesMap) {
    const cur = currFeaturesMap[id];
    const prev = prevFeaturesMap[id];
    const status = cur.properties.customName;

    if (!["Оккупировано", "Освобождено"].includes(status)) continue;

    if (prev) {
      try {
        const diff = turf.difference(cur, prev);
        if (diff) {
          const color = status === "Оккупировано" ? '#ff0000' : '#32CD32';
          changes.push({
            ...cur,
            geometry: diff.geometry,
            properties: {
              ...cur.properties,
              fillColor: color,
              customName: `Изменение (${status})`
            }
          });
        }
      } catch (e) {
        console.error(`Ошибка при сравнении полигона ${id}:`, e);
      }
    }
  }

  return changes;
}

map.on('load', () => {
  updateDatePanel();
  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');
});

map.on('error', (e) => {
  if (e.error && e.error.message.includes('Style is not done loading')) return;
  console.error("Ошибка карты:", e.error);
});
</script>
</body>
</html>
